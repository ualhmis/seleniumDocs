:encoding: utf-8
:lang: es
:toc: right
:toc-title: Tabla de contenidos
:doctype: book
:icons: font
////
Nombre y título del trabajo
////
= Ejercicios Selenium. Aplicación con base de datos
Herramientas y Métodos en Ingeniería del Software
Joaquín Cañadas <jjcanada@ual.es>

// Entrar en modo no numerado de apartados
:numbered!: 
:imagesdir: ../images
:figure-caption: Figura


// Bloque para GitHub, para que al visualizar el .adoc encuentre las figuras.
ifdef::env-github[]
:imagesdir: ../images
:figure-caption: Figura
endif::[]

:page-component-display-version: curso.2022
_Version_ *{page-component-display-version}*

[abstract]
////
COLOCA A CONTINUACIÓN EL RESUMEN
////
Ejercicios de tests de aceptación con Selenium.

////
COLOCA A CONTINUACIÓN LOS OBJETIVOS
////
.Objetivos
* Comenzar a crear tests de aceptación de aplicaciones web con Selenium IDE.

.Realización y entrega
****
La realización de estas actividades se realizará *en equipo*. La entrega será mediante el envío de un informe y el acceso al profesor a los repositorios y servicios configurados, para la revisión y evaluación de los mismos. 
****

// Entrar en modo numerado de apartados
:numbered:



// == Ejercicios Parte 1: Selenium IDE

== Test de la web del equipo

Realiza con Selenium IDE los tests de la web del equipo de la sesión 04 que verifiquen que la web incorpora todos los elementos que se pedían que se incluyeran en la misma. 

Como siempre, crea un repositorio (privado) en GitHub para guardar los archivos creados. Se trata de una actividad en equipo, así que aplica el método de colaboración fork + pull request. Comparte el repositorio con el profesor para que pueda tener acceso al mismo.


== Aplicación web con base de datos

Desde ahora hasta el final de la asignatura vamos a iniciar un proyecto de equipo consistente en el desarrollo de una aplicación  web dinámica (con base de datos) sobre el que aplicar las herramientas y métodos que vamos introduciendo durante el curso. El proyecto tendrá diversa funcionalidad, como las operaciones CRUD (Create, Read, Update, Delete) sobre una o varias entidades, un login y registro de usuarios, etc., así que vamos a comenzar por implementar esta funcionalidad. Tenemos dos alternativas: elegir una plantilla de proyecto que ya implemente la funcionalidad deseada, o bien hacerlo nosotros mismos.


=== Elige una plantilla 

Os dejo aquí en enlace a la documentación oficial de https://docs.microsoft.com/es-es/azure/app-service/[Azure Web apps, window=_blank] varios ejemplos de plantillas de *aplicación web con base de datos*, en distintas tecnologías, que básicamente implementan una aplicación que permite crear tareas, listarlas, modificarlas y eliminarlas. Podrás encontralas en el menú _Tutoriales_ / _Aplicación con base de datos_.

.Tutoriales de Aplicación Web con base de datos
image::azure-tutoriales-basededatos.png[role="thumb", align="center"]

.Proyecto TO-DO - Opciones
****
Elige la tecnología que prefieras, os animo a elegir una que tengáis curiosidad por aprender. Seguramente seguirás usando esa tecnología para el proyecto hasta el final de la asignatura, así que tomad la decisión en equipo. En cualquier caso, si más adelante quieres cambiar de tecnología para alguna de las siguientes prácticas, no habrá problema. 

Como alternativa, si lo deseas, puedes usar alguna otra plantilla que conozcas que no esté entre los tutoriales de Azure, incluso en otra tecnología (por ejemplo, Go). En ese caso, comentádmelo antes para validar que implemente la funcionalidad básica requerida (CRUD).

****

Sique las instrucciones del tutorial elegido, pero antes ten en cuenta lo siguiente:

- En la mayoría de los tutoriales te indicará los pasos para probar que la aplicación funciona _en local_ antes de subirla a la Web App de Azure. Cuando sea necesario, el tutorial te indicará unos *Prerrequitos* que tendrás que tener en tu PC local, y ofrecerá dos opciones:

    * Use el entorno de Bash en https://docs.microsoft.com/es-es/azure/cloud-shell/quickstart[Azure Cloud Shell, window=_blank]: tiene la ventaja de que todo el software necesario ya está instalado en la Cloud Shell, por lo que no necesitarás instalar nada en local. 

    * Si prefieres ejecutar la aplicación localmente, esta opción implica que debes instalar todo el software indicado como prerrequisitos que aun no tengas en tu PC (php, node, python, etc).

- Comprueba el gasto que vas a realizar con la creación de la Web App y la base de datos del tutorial que elijas. El consumo de la Web App dependerá del tipo de SKU que crea tutorial. Los pasos para crear una web app gratuita (SKU Free) están buen detallados en el apartado https://docs.microsoft.com/es-es/azure/app-service/tutorial-dotnetcore-sqldb-app?tabs=azure-portal%2Cvisualstudio-deploy%2Cdeploy-instructions-azure-portal%2Cazure-portal-logs%2Cazure-portal-resources#2---create-the-app-service[2. Creación de la instancia de App Service] del tutorial de DotNet Core, así que consultalos si es necesario. 

- Los comandos que aparencen en los tutoriales que comienzan por `az` permiten interactuar con los servicios Azure utilizando la CLI (Command Line Interface) de Azure. Básicamente, la CLI es una alternativa a usar el Portal de Azure, de manera que en lugar de operar forma interactiva sobre la interfaz web del Portal Azure, utilizarás los comandos de la CLI para crear y configurar los servicios. Los comandos `az` los podrás ejecutar https://docs.microsoft.com/es-es/azure/cloud-shell/quickstart[Azure Cloud Shell, window=_blank] (recomendado) o bien en local, y en este último caso (https://docs.microsoft.com/es-ES/cli/azure/install-azure-cli[instale la CLI de Azure, window=_blank]). 


=== Usa tu propio proyecto
Como alternativa, si ya has desarrollado o estás desarrollando un proyecto similar en alguna tecnología que conozcas, y que implemente: 

- la funcionalidad de listado, creación, modificación y eliminación (CRUD) sobre al menos una determinada entidad (por ejemplo: tareas, usuarios, eventos, etc.)

Pero asegúrate de que tu proyecto es *funcional*, es decir, implementa las características indicadas y estas funcionan, ya que el objetivo es probarlas con Selenium. Y además tu proyecto debe implementar los casos de error mediante los mensajes de validación oportunos. Si tu proyecto no es funcional, o no implementa esas características o los casos de error, entonces mejor usa una plantilla de las propuestas. 

== Creación de los tests Selenium

Crear en Selenium los test cases necesarios para probar, tanto escenarios correctos como escenarios de error, de las siguientes funcionalidades:
****
- Listado de tareas (Caso correcto)
- Listado de tareas (Casos incorrectos)
- Creación de una tarea (Caso correcto)
- Creación de una tareas (Casos incorrectos)
- Modificación de una tarea (caso correcto)
- Modificación de una tarea (casos incorrectos)
- Eliminación de una tarea (caso correcto)
- Eliminación de una tarea (casos incorrectos)
****
[NOTE]
====
En función de la tecnología que hayas elegido, tu plantilla de aplicación web tendrá todas estas funcionalidades, alguna de las indicadas anteriormente no estará implementada, o bien incorporará alguna funcionalidad adicional. En caso de que falte alguna, no te preocupes, crea los tests de las funcionalidades que estén incorporadas. Y si por el contrario la plantilla ofrece alguna funcionalidad adicional, puedes crear los tests de esa funcionalidad adicional de forma _optativa_.
====
Guardar los test cases en una test suite (formato `.side`).

Puesto que para realizar una prueba exhaustiva, cubriendo todos los posibles escenarios, el número de casos de prueba es elevado, la forma de trabajar es dividir las funcionalidades entre los miembros del equipo y así repartir el trabajo: Una persona que haga los tests de las dos primeras funcionalidades, y otra el resto. 

Para *equipos de 3 personas*, se pide elegir dos tecnologías y crear los tests de selenium para los dos proyectos. Al ser más carga de trabajo, en este caso se deja como optativo los tests de _Modificación de una tarea_.

== Funciones avanzadas de Selenium IDE

Ciertos pasos de algunos casos de prueba no se podrán grabar grabar con Selenium IDE, sino que habrá que modificarlos manualmente. A continuación, se ponen algunos ejemplos.

=== Creación de una tarea ya existente (Caso correcto)

Para que el test de creación de una tarea, si suponemos que el nombre de la tarea es un identificador único, no debería permitir crear una nueva tarea con el nombre de una tarea ya existente. La plantilla que estés usando puede que valide esta restricción o no. Si lo hace, para poder ejecutar este test repetidamente sin que de el error de "tarea ya existe", tenemos que usar un texto aleatorio en cada ejecución del test. Eso se consigue definiendo una variable en Selenium, llamado al comando `execute script`, escribiendo la función de JavaScript que genere ese valor te texto, por ejemplo un email aleatorio, y guardándolo en una variable que luego usaremos en en paso que escribe el valor en el campo _tarea_ del formulario de creación. 


El paso sería del test case de Selenium IDE es: 

- Command: *execute script*
- Target: `return "ual-" + Math.floor(Math.random()*1500000)+"@ual.es"``
- Value: `emailramdon`

.Generación de un email aleatorio
image::register-email-ramdon.png[role="thumb", align="center"]

=== Implementación del test incorrecto con validación HTML5

En aquellos formularios en los que se debe introducir un valor, por ejemplo una dirección de email y el campo está definido como tal en HTML5 mediante `<input type="email" ...>`, el valor introducido se valida en el navegador de manera que cuando el valor introducido no es un email válido muestra un pop-up con el texto _"Introduzca una dirección de correo."_ Este tipo de pop-ups no se pueden capturar con el menú contextual de Selenium IDE (botón derecho sobre el texto a validar), por lo que debemos usar un método alternativo.

.Pop-up de validación en HTML5: email incorrecto
image::selenium-ide-email-incorrecto.png[role="thumb", align="center", width=70%]

Para ello, tras hacer click sobre el botón de _enviar_, debemos usar el comando `execute script` de Selenium IDE para que guarde el valor del atributo `validationMessage` del campo tipo email en una variable, y a continuación comprobamos el valor almacenado en esa variable. El resultado sería tal que así:

.Comandos en Selenium IDE para validar el mensaje de email incorrecto.
image::selenium-ide-email-incorrecto-commands.png[role="thumb", align="center"]

<1> Guarda el contenido del atributo `validationMessage` del campo con id `email-address` en la variable `message`: 
- Command: *execute script*
- Target: `return document.getElementById("email-address").validationMessage`
- Value: `message`. 
<2> Muestra la variable `message` en el log de Selenium IDE.
<3> Validación de que el valor de `message` es el esperado.

El comando `execute script` permite acceder a los elementos y propiedades del https://www.w3schools.com/jsref/dom_obj_document.asp[DOM] del documento HTML, y llamar a los métodos del mismo, en concreto en el ejemplo llama a https://www.w3schools.com/jsref/met_document_getelementbyid.asp[getElementById("fieldId")]. 

En caso de que el elemento no se pueda identificar por su `id`, como alternativa se usar el método  https://www.w3schools.com/jsref/met_document_getelementsbyclassname.asp[getElementsByName("fieldName")], pero ten en cuenta que `getElementsByName` devuelve una colección de objetos https://www.w3schools.com/jsref/dom_obj_htmlcollection.asp[HTMLCollection] en lugar de un único objeto, por lo que si queremos acceder al primer elemento de la colección simplemente tenemos que añadir la posición entre corchetes: `getElementsByName("fieldName")[0]`. 

Otras alternativas son https://www.w3schools.com/jsref/met_document_getelementsbyclassname.asp[getElementsByClassName()], y https://www.w3schools.com/jsref/met_document_getelementsbytagname.asp[getElementsByTagName()].

Esta solución también se puede aplicar a otros campos de HTML5 que también crean este tipo de _pop-ups_ para la validación, por ejemplo los campos que se establecen como requeridos, o con una longitud mínima y máxima, definidos por ejemplo así:  `<input type="password" required minlength="6" maxlength="10"/>`

.Pop-up de validación en HTML5: contraseña requerida
image::selenium-ide-contraseña-requerida.png[role="thumb", align="center", width=60%]

.Comandos en Selenium IDE para validar contraseña vacía.
image::selenium-ide-contraseña-requerida-assert.png[role="thumb", align="center", width=90%]

.Pop-up de validación en HTML5: contraseña demasiado corta
image::selenium-ide-contraseña-incorrecta.png[role="thumb", align="center", width=60%]

Otro ejemplo son los campos de fecha definidos como `<input type="date" ...>`

.Pop-up de validación en HTML5: fecha incorrecta
image::https://mdn.mozillademos.org/files/14913/date-picker-chrome-error-message.png[role="thumb", align="center"]

[NOTE]
====
Los mensajes de validación son distintos en cada navegador (https://hg.mozilla.org/l10n-central/es-ES/file/default/dom/chrome/dom/dom.properties[Firefox], https://chromium.googlesource.com/chromium/src/\+/a0e2753f75c926313e183b912584a7f15790825d/content/app/strings/translations/content_strings_es.xtb[Chrome]), tenlo en cuenta a la hora de definir el `assert`. También hay que considerar el idioma en el que esté configurado el navegador (En Firefox,  en su https://hg.mozilla.org/l10n-central[repostorio] selecciona el idioma deseado y busca el archivo `dom/chrome/dom/dom.properties`, y en https://chromium.googlesource.com/chromium/src/+/a0e2753f75c926313e183b912584a7f15790825d/content/app/strings/translations/[Chrome] lo encontrarás en el archivo del idioma, en español https://chromium.googlesource.com/chromium/src/\+/a0e2753f75c926313e183b912584a7f15790825d/content/app/strings/translations/content_strings_es.xtb[content_strings_es.xtb]). 

.Validación de email incorrecto en Firefox y Chrome
[cols="^,^", valign=top, grid=none, stripes=even]
|===

| image:https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg[width=10%]  
| image:https://www.google.com/chrome/static/images/chrome-logo.svg[width=11%]

| image:selenium-ide-email-incorrecto-firefox.png[role="thumb"] 
| image:selenium-ide-email-incorrecto-chrome.png[role="thumb"]

|===

Como acabamos de ver en el punto anterior, puede ser necesario que en función del navegador que estemos usando o del idioma en que esté configurado dicho navegador, nuestro `assert` deba validar un mensaje u otro.

====


=== Control de flujo en Selenium IDE

Selenium IDE permite añadir sentencias de https://www.selenium.dev/selenium-ide/docs/en/introduction/control-flow[control de flujo] como https://www.selenium.dev/selenium-ide/docs/en/introduction/control-flow#conditional-branching[*condicionales*] y https://www.selenium.dev/selenium-ide/docs/en/introduction/control-flow#looping[*bucles*]. 

El siguiente https://github.com/ualjjcanada/selenium-ide-samples[ejemplo] usa de la propiedad `navigator.userAgent` que incluye información del navegador que se está utilizando en la ejecución del test.

[source]
----
execute script | return navigator.userAgent  |  valor_navigatoruserAgent
if             | ${navigatoruserAgent}.includes("Firefox")
assert         | message | Ajústese al formato solicitado: 8 character password.
end            |
if             | ${navigatoruserAgent}.includes("Chrome")
assert         | message | Utiliza un formato que coincida con el solicitado
end            |


----

.Uso de condicional para distinguir entre navegadores
image::selenium-ide-conditional-navigators.png[role="thumb", align="center", width=100%]

De igual forma, la propiedad `navigator.language` puede ayudarnos a identificar el idioma del navegador: `es_ES` para español, `en_GB` para inglés.

== Desplegar la aplicación en Azure

La aplicación que hemos probado localmente, debemos ponerla "en producción", es decir, desplegarla en Azure para que esté disponible por nuestros usuarios (ficticios).

Dependiendo de la plantilla elegida, el despliegue será distinto. Los tutoriales indican como hacerlo mediante Web Apps. 

Si los test los has creado en el _entorno de desarrollo_, es decir, en nuestro equipo local, deben adaptarse para que funcionen en _entorno de producción_ es decir, deben atacar a la aplicación desplegada. Para ello simplemente tendrás que *cambiar la URL base*. 

