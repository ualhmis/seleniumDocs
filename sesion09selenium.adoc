////
Codificación, idioma, tabla de contenidos, tipo de documento
////
:encoding: utf-8
:lang: es
:toc: right
:toc-title: Tabla de contenidos
:keywords: Selenium end-to-end testing
:doctype: book
:icons: font

////
/// activar btn:
////
:experimental:

:source-highlighter: rouge
:rouge-linenums-mode: inline

// :highlightjsdir: ./highlight

:figure-caption: Fig.
:imagesdir: images

////
Nombre y título del trabajo
////
= Actividad 9. Pruebas de aceptación con Selenium

Herramientas y Métodos en Ingeniería del Software
Version 1.0, Mayo-2020.
Joaquín Cañadas <jjcanada@ual.es>

// Entrar en modo no numerado de apartados
:numbered!: 

[abstract]
////
COLOCA A CONTINUACIÓN EL RESUMEN
////
Tests de aceptación con Selenium.

////
COLOCA A CONTINUACIÓN LOS OBJETIVOS
////
.Objetivos
* 
* 
* 
* 

.Realización y entrega
****
La realización de estas actividades se realizará en equipo. La entrega será mediante el envío de un informe y el acceso al profesor a los servicios configurados, para la revisión y evaluación de los mismos. 
****

// Entrar en modo numerado de apartados
:numbered:


== Introducción a Selenium
https://www.selenium.dev/[Selenium] es un conjunto de herramientas para llevar a cabo pruebas automatizadas de aplicaciones web.

Selenium consta de varias herramientas. 

- https://www.selenium.dev/selenium-ide/[*Selenium IDE*] es una extensión para https://addons.mozilla.org/es/firefox/addon/selenium-ide/[Firefox] y para https://chrome.google.com/webstore/detail/selenium-ide/mooikfkahbdckldjjndioackbalphokd[Chrome] que registra nuestra actividad en el navegador durante un período determinado; esta actividad se traduce en una serie de https://www.selenium.dev/selenium-ide/docs/en/api/commands[comandos] que podremos repetir cuantas veces queramos. Cuando sea conveniente, incluiremos *aserciones* para realizar comprobaciones de que lo que se muestra en la web es realmente lo esperado. Con Selenium IDE podemos _grabar_ casos de prueba o _test cases_, y agruparlos en juegos de prueba o _test suites_. *Selenium IDE* permite exportar los _test cases_ en forma de scripts en muy diversos lenguajes, como Python, Ruby, Java (JUnit), C#, NodeJS (JavaScript), y algunos más, para ser usados en los entornos de prueba habituales usando el siguiente componente de Selenium, llamado *Selenium WebDriver*.

-  https://www.selenium.dev/documentation/en/getting_started_with_webdriver/[*Selenium WebDriver*], implementa una API cliente lista para ser usada con tu entorno de testing favorito, que se ejecutará sobre un servidor que gestiona los principales navegadores que tengas instalados para realizar en ellos las pruebas. Es decir, podrás ejecutar las pruebas automáticamente desde tu IDE favorito, por ejemplo Eclipse, en todos los navegadores relevantes, de forma que no se te escape ningún detalle de tu aplicación. Para ello, necesitarás descargar del _driver_ del navegador sobre el que quieres ejecutar las pruebas (además de, por supuesto, tener instalado dicho navegador en tu sistema).

- Un tercer componentes es https://www.selenium.dev/documentation/en/grid/[*Selenium Grid*], que permite ejecutar varias instancias del WebDriver de forma paralela, en distintas máquinas con distintas plataformas o sistemas operativos, gestionándolas centralizadamente, lo que acelerará drásticamente los tiempos de prueba.

== Selenium IDE

Instala en tu equipo Selenium IDE en https://addons.mozilla.org/es/firefox/addon/selenium-ide/[Firefox] o https://chrome.google.com/webstore/detail/selenium-ide/mooikfkahbdckldjjndioackbalphokd[Chrome]. Tras ello, aparecerá el icono en tu navegador.

.Icono de Selenium IDE en el navegador
image::selenium-ide-icon.png[role="thumb", align="center"]

Al hacer clic sobre el icono, se abrirá Selenium IDE. Empieza por crear un nuevo proyecto:

.Selenium IDE inicio
image::selenium-ide-open-1.png[role="thumb", align="center"]

Escribe un nombre al nuevo proyecto de pruebas:

.Selenium IDE inicio
image::selenium-ide-open-new-project.png[role="thumb", align="center"]

Introduce la URL base a probar:

.Selenium IDE URL base
image::selenium-ide-open-url-base.png[role="thumb", align="center"]

Directamente empieza a grabar las acciones que vayas realizando sobre el navegador:

.Selenium IDE grabando
image::selenium-ide-start-recording.png[role="thumb", align="center"]

Durante tu interacción con la web que estés probando *SIEMPRE es necesario ir añadiendo _asserts_* o verificaciones para comprobar que lo que muestra la aplicación corresponde con lo esperado.

.Selenium IDE assert text
image::selenium-ide-assert-text.png[role="thumb", align="center"]

En la ventana de Selenium IDE, puedes ver que se van grabando en los comandos de Selenium los pasos realizados sobre el navegador (clics, entradas de texto, asserts, etc). 

.Selenium IDE pasos guardados
image::selenium-ide-saved-steps.png[role="thumb", align="center"]

Finaliza la grabación del test en el botón de detener, y dale un nombre al test case creado:

.Selenium IDE guardar test case
image::selenium-ide-stop-test-name.png[role="thumb", align="center"]


A continuación, dale al _play_ para volver a ejecutar el test: 

.Selenium IDE detener grabación
image::selenium-ide-play-test.png[role="thumb", align="center"]

Siguiendo estos sencillos pasos, puedes grabar tantos casos de prueba como sean necesarios para ejercitar tu aplicación web y verificar que todos escenarios de los casos de uso funcionan correctamente. 

Recuerda que es necesario crear casos de prueba para: 

- Los *escenarios correctos*, en los que la aplicación realiza el caso de uso correctamente, tal y como se espera. 

- Los *escenarios de error o incorrectos*, donde el funcionamiento del caso de uso no es el caso correcto, bien porque los datos introducidos no son adecuados, o faltan, o por cualquier otro motivo. La aplicación en ese caso debería mostrar un mensaje de error de algún tipo y comportarse de manera estable, es decir, que se queda en un estado aceptable y _"no peta"_ en esos escenarios incorrectos.


== Pasos a realizar

=== Parte 1: Selenium IDE

==== Aplicación web login y registro de usuarios

Os dejo aquí tres ejemplos de plantillas de aplicación web que implementan un login y registro de usuarios. 

. Elegid una de las plantillas. Si deseáis usar alguna otra plantilla en otra tecnología, comentádmelo antes por si implementa la funcionalidad básica requerida.

. En local, crear el proyecto basado en la plantilla. Probar que funciona.

==== Creación de test Selenium

Crear en Selenium los test cases necesarios para probar, tanto escenarios correctos como escenarios de error, de las siguientes funcionalidades:

- Registro de usuario (Caso correcto)
- Registro de usuario (Casos incorrectos)
- Login de usuario (Caso correcto)
- Login de usuario (Casos incorrectos)
- Editar el perfil de usuario logueado (caso correcto)
- Editar el perfil de usuario logueado (casos incorrectos)
- Cambio de contraseña de usuario logueado (Caso correcto)
- Cambio de contraseña de usuario logueado (Casos incorrectos)

Guardar los test cases en una test suite (formato .side).

Puesto que para realizar una prueba exhaustiva, cubriendo todos los posibles escenarios, el número de casos de prueba es elevado, la forma de trabajar es repartir las funcionalidades entre los miembros del equipo y así repartir el trabajo: Una persona que haya los tests de Registro de usuario + Editar perfil, y otra los de login de usuario + cambio de contraseña. Para equipos de 3 personas, una el registro, otra el login y otra la edición de perfil y cambio de contraseña.

.Truco para el test Registro de usuario (Caso correcto)
****
Para que el test de registro de usuario lo podamos ejecutar repetidamente sin que nos de el error de "usuario ya existe", tenemos que usar un email aleatorio en cada ejecución del test. Eso se consigue definiendo una variable en Selenium, llamado al comando `execute script`, escribiendo la función de JavaScript que genere ese email aleatorio, y guardándolo en una variable que luego usaremos en en paso que escribe el valor en el campo _email_ del registro. 

El paso sería del test case de Selenium IDE es: 

- Command: *execute script*
- Target: `return "ual-" + Math.floor(Math.random()*1500000)+"@ual.es"``
- Value: `emailramdon`

.Generación de un email aleatorio
image::register-email-ramdon.png[role="thumb", align="center"]

****

==== Desplegar la aplicación en Azure

La aplicación que hemos probado localmente, debemos ponerla "en producción", es decir, desplegarla en Azure para que esté disponible por nuestros usuarios (ficticios).

Dependiendo de la plantilla elegida, el despliegue será distinto. La plantilla de .Net explica el despliegue en Azure Web app. El resto se pueden desplegar en Web app, o bien en una máquina virtual. 

==== Adaptar los test a la URL de despliegue

Los test que hemos creado en el _*entorno de desarrollo*_, es decir, en nuestro equipo local, deben adaptarse para que funcionen en _*entorno de producción*_ es decir, deben atacar a la aplicación desplegada. 

Para ello simplemente tendrás que cambiar la URL base. 

=== Parte 2: Selenium WebDriver y Jenkins

WebDriver permite ejecutar los tests de Selenium como tests de JUnit, permitiendo así su ejecución en Eclipse y Jenkins. 

==== Exportar a JUnit

Exporta a formato JUnit los tests grabados con Selenium IDE. Tendrás que hacerlo uno por uno, ya que por ahora Selenium IDE no permite exportarlos todos a la vez. 

.Exportar test case
image::selenium-ide-export-test.png[role="thumb", align="center"]

.Exportar formato JUnit
image::selenium-ide-export-test-junit.png[role="thumb", align="center"]

Guarda los archivos `.java` en una carpeta. A continuación los importaremos en Eclipse.

==== Cross-browser testing con Firefox y Chrome en Eclipse

Partiendo del repositorio https://github.com/ualhmis/seleniumWebDriverJUnit realizar los siguientes pasos:

[IMPORTANT]
====
Los test de JUnit exportados por Selenium IDE están en formato JUnit 4. Para evitar más modificaciones de las necesarias, la dependencia en el pom del proyecto está configurada a JUnit 4.
====

. Un miembro del equipo clona el repositorio (previamente forkeado). Siguiendo el método de trabajo en equipo, el otro miembro forkea el repositorio del compañero y propondrá cambios mediante pull request.

. Cada miembro del equipo crea una carpeta `drivers` en el proyecto en Eclipse. Y añade la carpeta al `.gitginore` para que el contenido no se guarde en el repositorio.

[source]
..gitignore
----
**/bin
**/target
**/drivers
----


[WARNING]
====
Es importante que los drivers específicos de los navegadores no se guarden en GitHub, ya que son archivos ejecutables (dependencias) que no deben versionarse. Cuando los necesites, tendrás que descargarlos. 
====

[start=3]
. En es carpeta descarga los drivers de los navegadores Firefox y Chrome. Para ello: 
.. Descarga y descomprime Firefox driver (Gecko Driver) de https://github.com/mozilla/geckodriver/releases eligiendo la versión adecuada para tu sistema.
.. Descarga y descomprime Chrome driver de https://sites.google.com/a/chromium.org/chromedriver/downloads eligiendo la versión del driver correspondiente a la versión de Chrome que tengas instalado en tu sistema.
.. Con estos dos drivers es suficiente, pero puedes ver como descargar los drivers de otros navegadores aquí: https://www.selenium.dev/documentation/en/webdriver/driver_requirements/[Driver requirements].

[start=4]
. Crea un nuevo paquete en la carpeta test de nombre `org.ual.hmis.nombreEquipo` (sustituyendo `nombreEquipo` por el nombre de tu equipo). Ahí guarda los archivos `.java` exportados de Selenium IDE. 

. A continuación se indican unas mínimas modificaciones: 
.. Añade el paquete a cada archivo `.java`
.. En el método `setUp()`, añade justo al principio las sentencias para configurar la ruta a cada driver:

[source,java]
----
  @Before
  public void setUp() throws Exception {

	System.setProperty("webdriver.gecko.driver", "drivers/geckodriver.exe"); <1>

	System.setProperty("webdriver.chrome.driver", "drivers/chromedriver.exe"); <2>
    ...
  }
----
<1> Son rutas relativas en el proyecto, dentro de `drivers`. Usa la ruta adecuada en tu caso.
<2> Idem 

[start=6]
. Ejecuta los tests como JUnit Test. Verás que se abre Firefox y ejecuta los test automáticamente. 

. Si un test falla, revisa el código y los pasos incluidos. Puede haber pasos que sobren, o que al exportarlos a JUnit tengas que adaptarlos a Java. Los fallos se pueden deber al selector que ha tomado automáticamente Selenium IDE. El https://www.browserstack.com/guide/locators-in-selenium[selector] identifica el elemento dentro de la página web sobre el que se ha interactuado, y para ello utiliza bien la referencia CSS o bien XPATH. Ve a Selenium IDE y cambia el selector, en la propiedad `target`; es recomendable utilizar la opción que identifica el elemento por `xpath` y el texto que queremos seleccionar. Por ejemplo, en un comando `click`: 

.Cambiar el selector de un elemento de la página
image::selenium-ide-change-selector-xpath.png[role="thumb", align="center"]

También puede ser necesario añadir un tiempo de espera a que se cargue el formulario, antes del primer `sendKeys`, y también antes y después de `click()` en un botón de formulario. 

[source,java]
----
	    try {
	        Thread.sleep(1000);
	      } catch (InterruptedException e) {
	        e.printStackTrace();
	      }
----

[start=8]

. A continuación vamos a probar en otro navegador, haciendo así lo que se denomina https://developer.mozilla.org/en-US/docs/Learn/Tools_and_testing/Cross_browser_testing/Introduction[_cross-browser testing]_. En los archivos `.java` cambia el driver a Chrome:

[source,java]
----
  @Before
  public void setUp() throws Exception {
      ...
      // driver = new FirefoxDriver();
	  driver = new ChromeDriver();
----

Verás que se abre Chrome y se ejecuta el mismo test.

Si un test se ejecuta correctamente en Firefox pero falla en Chrome: 
- comprueba el tamaño de la ventana, agrándala por si es el problema:

    driver.manage().window().setSize(new Dimension(1080, 824));

- modifica los selectores, en lugar de `cssSelector` utiliza `xpath`
- Añade un tiempo de espera a que se cargue el formulario, antes del primer `sendKeys`, y también después de `click()` en un botón de formulario. 

[source,java]
----
	    try {
	        Thread.sleep(1000);
	      } catch (InterruptedException e) {
	        e.printStackTrace();
	      }
----


==== Configurar un driver _headless_

El modo _headless_ sirve para ejecutar los tests sin que se visualice la ventana del navegador. Esto hace que los tests se ejecuten más rápido y más eficientemente, especialmente en un entrono de Integración Continua como Jenkins. 

===== Firefox en modo _headless_

En local, para ejecutar Firefox en modo _headless_: 

[source,java]
----
  @Before
  public void setUp() throws Exception {
      ...
      FirefoxOptions firefoxOptions = new FirefoxOptions();
	  firefoxOptions.setHeadless(true);
	    
	  driver = new FirefoxDriver(firefoxOptions);
      ...
----

Además deberás añadir en los imports: 

`import org.openqa.selenium.firefox.FirefoxOptions;`

Prueba a ejecutar los tests y verás que se ejecutan sin visualizar la ventana de Firefox. Lanza los test tanto con  Eclipse como con Maven.

===== ChromeDriver en modo _headless_

ChromeDriver funciona de manera similar a Geckodriver de Firefox, e implementa la especificación  https://www.w3.org/TR/webdriver/[W3C WebDriver]. 

En local, para ejecutar Chrome en modo _headless_: 

[source,java]
----
  @Before
  public void setUp() throws Exception {
      ...
      ChromeOptions chromeOptions = new ChromeOptions();
      chromeOptions.setHeadless(true);
	    
	  driver = new ChromeDriver(chromeOptions);
      ...
----

Además deberás añadir en los imports

    import org.openqa.selenium.chrome.ChromeOptions;

Durante la ejecución no se abrirá la ventana de Chrome y los tests se ejecutarán correctamente. Lanza los test tanto con Eclipse como con Maven.


===== HtmlUnitDriver: modo _headless_ nativo

En local, cambia el driver a `HtmlUnitDriver();`

[source,java]
----
  @Before
  public void setUp() throws Exception {
      ...
	  driver = new HtmlUnitDriver();
      ...
----

Debes importar la librería:

    import org.openqa.selenium.htmlunit.HtmlUnitDriver;

HtmlUnitDriver da muchos problemas, sobre todo con JavaScript. Es la versión reducida de un navegador, por lo que no soporta gran parte de la funcionalidad del mismo, y la mayoría de tests que funcionan para FirefoxDriver y ChromeDriver fallan con HtmlUnitDriver. Si te fallan los test HtmlUnitDriver no te preocupes. El modo _headless_ de FirefoxDriver y ChromeDirver nos ayudará a nuestro objetivo. 

==== Ejecución en Jenkins

Lo primero es descargar los drivers de los navegadores en la máquina de Jenkins. 

. En la carpeta JENKINS_HOME (si no recuerdas cual es, puedes verla en http://mi-jenkins-url/systemInfo) crea una carpeta `selenium-drivers`y descarga ahí los drivers de los navegadores Firefox y Chrome para Ubuntu. Para ello, ejecuta estos comandos en la máquina Jenkins.

[source,bash]
----
cd
JENKINS_HOME=tu/path/a/jenkins_home
echo $JENKINS_HOME
mkdir $JENKINS_HOME/selenium-drivers <1>
wget https://github.com/mozilla/geckodriver/releases/download/v0.26.0/geckodriver-v0.26.0-linux64.tar.gz
tar -C $JENKINS_HOME/selenium-drivers/ -xvf geckodriver-v0.26.0-linux64.tar.gz 
wget https://chromedriver.storage.googleapis.com/83.0.4103.39/chromedriver_linux64.zip
sudo apt-get intall unzip -y
unzip chromedriver_linux64.zip -d $JENKINS_HOME/selenium-drivers/
ls -la  $JENKINS_HOME/selenium-drivers/
----
<1> Asegúrate que tienes permisos suficientes. Si necesitas usar `sudo` deberás de cambiar los permisos y grupos de los archivos al usuario jenkins:jenkins.

[start=2]
. Crea en Jenkins un nuevo proyecto pipeline. Incluye la fase (_stage_) con nombre `Firefox tests`, donde llames a maven: 

    mvn test -Dwebdriver.gecko.driver=~/selenium-drivers/geckodriver 


[WARNING]
====
Comprueba que en el código de los tests estás usando `FirefoxDriver`, y modo _headless_
====

[start=3]
. Publica la gráfica de los tests en un bloque `post` del pipeline.

. Crea una nueva fase donde llames a los tests con el driver de Chrome. Tendrás que modificar el driver en el código.

     mvn test -Dwebdriver.chrome.driver=~/selenium-drivers/chromedriver

. Instala firefox en tu máquina Jenkins
    
    sudo apt-get install -y firefox

[IMPORTANT]
====
EJERCICIO: 
- Rediseña las clases JUnit con los test de Selenium para poder lanzar los tests bien con Firefox o bien con en Chrome, sin tener que modificar el código fuente, es decir, sin tener que cambiar el driver "a mano". Dependiendo de tu diseño, tal vez puedas necesitar https://openclassrooms.com/en/courses/5661466-use-testing-in-java-to-achieve-quality-applications/6232331-label-your-tests-with-advanced-junit-annotations[categorías] de JUnit 4. 
- Crea dos fases en el pipeline, una para Firefox y otra para Chrome, y configura el pipeline para que se ejecuten en paralelo, usando el bloque `parallel`. 
====

== FAQ y resolución de problemas (_thoubleshouting_)

- Mas información sobre https://www.selenium.dev/maven[Maven con Selenium].

- https://www.browserstack.com/guide/selenium-with-java-for-automated-test[Buenas prácticas]: Selenium con Java